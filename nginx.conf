user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

# Carga módulos dinámicos
load_module /usr/lib/nginx/modules/ngx_http_headers_more_filter_module.so;

events {
    worker_connections  4096;
    multi_accept       on;
    use                epoll;
}

http {
    # Configuración básica
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Formatos de log
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';


    # Configuración de logs
    access_log  /var/log/nginx/access.log  main buffer=512k flush=1m;
    error_log   /var/log/nginx/error.log warn;

    # Optimizaciones de rendimiento
    sendfile            on;
    sendfile_max_chunk  1m;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65s;
    keepalive_requests  1000;
    types_hash_max_size 2048;
    server_tokens       off;
    client_max_body_size 10m;

    # Timeouts
    client_body_timeout   12s;
    client_header_timeout 12s;
    send_timeout         10s;

    reset_timedout_connection on;


    # Configuración de caché
    open_file_cache          max=2000 inactive=20s;
    open_file_cache_valid    60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors   on;

    # Compresión
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml application/xml+rss text/javascript application/x-javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;
    gzip_min_length 1000;
    gzip_disable "MSIE [1-6]\.";

    # Headers de seguridad
    more_set_headers 'X-Content-Type-Options: nosniff';
    more_set_headers 'X-Frame-Options: SAMEORIGIN';
    more_set_headers 'X-XSS-Protection: 1; mode=block';
    more_set_headers 'Referrer-Policy: strict-origin-when-cross-origin';
    more_set_headers 'Permissions-Policy: geolocation=(), microphone=()';

    # Configuración de caché de navegador
    map $sent_http_content_type $expires {
        default                    off;
        text/html                 epoch;
        text/css                  max;
        application/javascript     max;
        ~image/                   max;
        ~font/                    max;
        ~application/font-        max;
        ~application/x-font-      max;
    }


    # Incluir configuraciones adicionales
    include /etc/nginx/conf.d/*.conf;
}
